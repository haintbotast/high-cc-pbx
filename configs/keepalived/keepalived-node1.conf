#=====================================================================
# Keepalived Configuration - MASTER Node
# Node: voip-node1 (172.16.91.101)
# VIP: 172.16.91.100
# Priority: 100 (higher than standby)
# Based on production PostgreSQL HA setup
#=====================================================================

global_defs {
    # Router ID (unique identifier)
    router_id VOIP_HA_101

    # Enable script security
    enable_script_security
    script_user root
}

#---------------------------------------------------------------------
# Health Check Scripts
#---------------------------------------------------------------------

# Check VoIP services (PostgreSQL, Kamailio, FreeSWITCH, voip-admin)
vrrp_script chk_voip_master {
    script "/usr/local/bin/check_voip_master.sh"
    interval 3              # Check every 3 seconds
    timeout 5
    weight -30              # Decrease priority by 30 if check fails
    fall 2                  # Require 2 consecutive failures
    rise 2                  # Require 2 consecutive successes
}

#---------------------------------------------------------------------
# VRRP Instance for VoIP VIP
#---------------------------------------------------------------------
vrrp_instance VI_VOIP {
    state MASTER
    interface ens33          # Change to match your interface (eth0, ens192, etc.)
    virtual_router_id 51
    priority 100             # Higher than Node 2
    advert_int 1

    # Authentication - AH (Authentication Header) for security
    authentication {
        auth_type AH
        auth_pass Keepalv!VoIP#2025HA
    }

    # Virtual IP address
    virtual_ipaddress {
        172.16.91.100/24 dev ens33 label ens33:vip
    }

    # Track scripts
    track_script {
        chk_voip_master
    }

    # Unified notify script (handles MASTER/BACKUP/FAULT transitions)
    notify "/usr/local/bin/keepalived_notify.sh"

    # Preemption disabled for stability
    nopreempt
}
