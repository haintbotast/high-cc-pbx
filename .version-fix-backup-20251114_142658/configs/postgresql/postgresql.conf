# =============================================================================
# PostgreSQL 16 Configuration for High-Availability VoIP System
# Target: 600-800 concurrent calls with streaming replication
# Hardware: 16 cores, 64 GB RAM per node
# =============================================================================

# -----------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 500                   # Kamailio (200) + FreeSWITCH (100) + voip-admin (50) + overhead

# -----------------------------------------------------------------------------
# MEMORY SETTINGS (Total: ~12 GB for PostgreSQL)
# -----------------------------------------------------------------------------
shared_buffers = 8GB                    # 25% of 32 GB allocated to PostgreSQL
effective_cache_size = 24GB             # 75% of 32 GB
work_mem = 32MB                         # For sorting/hashing (500 conns * 32MB = 16GB max)
maintenance_work_mem = 1GB              # For VACUUM, CREATE INDEX
wal_buffers = 256MB                     # -1 = auto (3% of shared_buffers)

# -----------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
# -----------------------------------------------------------------------------
wal_level = replica                     # Required for streaming replication
fsync = on
synchronous_commit = off                # Trade-off: Better performance, risk losing last few ms of transactions
wal_sync_method = fdatasync
full_page_writes = on
wal_compression = on                    # Compress WAL (LZ4)
wal_log_hints = on                      # Required for replication

# WAL archiving
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/16/wal_archive/%f && cp %p /var/lib/postgresql/16/wal_archive/%f'
archive_timeout = 300                   # Force WAL archive every 5 minutes

# WAL size limits
min_wal_size = 2GB
max_wal_size = 8GB
wal_keep_size = 4GB                     # Keep 4 GB of WAL for standby

# Checkpoints
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# -----------------------------------------------------------------------------
# REPLICATION (PRIMARY)
# -----------------------------------------------------------------------------
max_wal_senders = 5                     # Max standby servers + buffer
max_replication_slots = 5
hot_standby = on                        # Enable read queries on standby
hot_standby_feedback = on               # Prevent query conflicts on standby
wal_receiver_status_interval = 10s
wal_sender_timeout = 60s
wal_receiver_timeout = 60s

# Synchronous replication (optional - uncomment for zero data loss)
# synchronous_commit = on
# synchronous_standby_names = 'node2'

# -----------------------------------------------------------------------------
# QUERY TUNING
# -----------------------------------------------------------------------------
random_page_cost = 1.1                  # SSD optimized (default 4.0 for HDD)
effective_io_concurrency = 200          # SSD can handle many concurrent I/O
max_worker_processes = 16               # Match CPU cores
max_parallel_workers_per_gather = 4
max_parallel_workers = 16
max_parallel_maintenance_workers = 4

# -----------------------------------------------------------------------------
# AUTOVACUUM (Critical for VoIP high-write workload)
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s                # Check for vacuum every 30s
autovacuum_vacuum_threshold = 1000
autovacuum_vacuum_scale_factor = 0.05   # Vacuum when 5% of table changes (default 20%)
autovacuum_analyze_threshold = 500
autovacuum_analyze_scale_factor = 0.05

# Aggressive vacuum for CDR tables (high churn)
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 500        # Log queries > 500ms
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = off                   # Too noisy for VoIP
log_disconnections = off
log_lock_waits = on
log_temp_files = 0                      # Log all temp files
log_autovacuum_min_duration = 250       # Log autovacuum > 250ms

# -----------------------------------------------------------------------------
# STATISTICS
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = '/var/run/postgresql/16-main.pg_stat_tmp'

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# LOCK MANAGEMENT
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 256         # Increase for complex queries

# -----------------------------------------------------------------------------
# ERROR HANDLING
# -----------------------------------------------------------------------------
restart_after_crash = on
