<!-- =============================================================================
     CDR PostgreSQL Configuration
     Description: Write CDRs to PostgreSQL voip.cdr_queue table
     ============================================================================= -->

<configuration name="cdr_pg_csv.conf" description="CDR PostgreSQL CSV">
  <settings>
    <!-- Database connection -->
    <param name="db-dsn" value="pgsql://host=172.16.91.100 dbname=voip user=freeswitch password=PASSWORD options='-c search_path=voip'"/>

    <!-- Table name -->
    <param name="db-table" value="cdr_queue"/>

    <!-- Log both legs of a call -->
    <param name="log-b-leg" value="true"/>

    <!-- Prefix for b-leg -->
    <param name="prefix-b-leg" value="b_"/>

    <!-- Rotate logs -->
    <param name="rotate-on-hup" value="true"/>

    <!-- Schema -->
    <schema>
      <field name="id" type="serial"/>
      <field name="payload" type="jsonb" chan-var-name="cdr_json"/>
      <field name="status" type="varchar" default="pending"/>
      <field name="attempts" type="integer" default="0"/>
      <field name="created_at" type="timestamp" default="current_timestamp"/>
    </schema>
  </settings>
</configuration>

<!-- Note: We use cdr_queue as a staging table. The voip-admin service
     will process these records asynchronously and move them to the final
     voip.cdr table with proper formatting -->
